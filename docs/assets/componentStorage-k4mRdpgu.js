var l=class{constructor(){this.dbName="vue-tools-components-db",this.dbVersion=1,this.storeName="components",this.db=null}async openIndexedDB(r,t){return new Promise((e,o)=>{const n=indexedDB.open(r);n.onerror=()=>o(n.error),n.onupgradeneeded=()=>{const a=n.result;a.objectStoreNames.contains(t)||a.createObjectStore(t,{keyPath:"id"})},n.onsuccess=()=>{const a=n.result;if(a.objectStoreNames.contains(t))e(a);else{const s=a.version+1;a.close();const c=indexedDB.open(r,s);c.onerror=()=>o(c.error),c.onupgradeneeded=()=>{const i=c.result;i.objectStoreNames.contains(t)||i.createObjectStore(t,{keyPath:"id"})},c.onsuccess=()=>e(c.result)}}})}async getBuilderStateByComponentId(r){try{const t=await this.openIndexedDB("lowcode-builder","states");return await new Promise((e,o)=>{const n=t.transaction("states","readonly").objectStore("states"),a=`component-${r}`,s=n.get(a);s.onsuccess=()=>e(s.result?{config:s.result.config,elements:s.result.elements||[],exportName:s.result.exportName,version:s.result.version}:null),s.onerror=()=>o(s.error)})}catch(t){return console.warn("读取构建器状态失败：",t),null}}async saveBuilderStateByComponentId(r,t){try{const e=await this.openIndexedDB("lowcode-builder","states");await new Promise((o,n)=>{const a=e.transaction("states","readwrite").objectStore("states"),s=`component-${r}`,c=a.put({id:s,...t,updatedAt:Date.now()});c.onsuccess=()=>o(),c.onerror=()=>n(c.error)})}catch(e){console.warn("写入构建器状态失败：",e)}}async getBuilderStateForComponent(r){return this.getBuilderStateByComponentId(r)}async saveBuilderStateForComponent(r,t){return this.saveBuilderStateByComponentId(r,t)}async getBuilderStateForProject(r){try{const t=await this.openIndexedDB("lowcode-builder","states");return await new Promise((e,o)=>{const n=t.transaction("states","readonly").objectStore("states"),a=`project-${r}`,s=n.get(a);s.onsuccess=()=>e(s.result?{config:s.result.config,elements:s.result.elements||[],exportName:s.result.exportName,version:s.result.version}:null),s.onerror=()=>o(s.error)})}catch(t){return console.warn("读取项目构建器状态失败：",t),null}}async saveBuilderStateForProject(r,t){try{const e=await this.openIndexedDB("lowcode-builder","states");await new Promise((o,n)=>{const a=e.transaction("states","readwrite").objectStore("states"),s=`project-${r}`,c=a.put({id:s,...t,updatedAt:Date.now()});c.onsuccess=()=>o(),c.onerror=()=>n(c.error)})}catch(e){console.warn("写入项目构建器状态失败：",e)}}async clearBuilderStateForProject(r){try{const t=await this.openIndexedDB("lowcode-builder","states");await new Promise((e,o)=>{const n=t.transaction("states","readwrite").objectStore("states"),a=`project-${r}`,s=n.delete(a);s.onsuccess=()=>e(),s.onerror=()=>o(s.error)})}catch(t){console.warn("清理项目构建器状态失败：",t)}}async clearProjectResources(r){try{await Promise.all([this.clearFontsByComponentId(r),this.clearIconsByComponentId(r),this.clearDatabaseObjectsByComponentId(r)])}catch(t){console.warn("清理项目资源失败：",t)}}async saveFontsForComponent(r,t){return this.saveFontsByComponentId(r,t)}async clearFontsForComponent(r){return this.clearFontsByComponentId(r)}async deleteFontForComponent(r,t){return this.deleteFontByComponentId(r,t)}async getIconsForComponent(r){return this.getIconsByComponentId(r)}async saveIconsForComponent(r,t){return this.saveIconsByComponentId(r,t)}async clearIconsForComponent(r){return this.clearIconsByComponentId(r)}async updateIconNameForComponent(r,t,e){return this.updateIconNameByComponentId(r,t,e)}async deleteIconForComponent(r,t){return this.deleteIconByComponentId(r,t)}async saveDatabaseObjectsForComponent(r,t){return this.saveDatabaseObjectsByComponentId(r,t)}async clearDatabaseObjectsForComponent(r){return this.clearDatabaseObjectsByComponentId(r)}async upsertDatabaseObjectForComponent(r,t){return this.upsertDatabaseObjectByComponentId(r,t)}async deleteDatabaseObjectForComponent(r,t){return this.deleteDatabaseObjectByComponentId(r,t)}b64FromArrayBuffer(r,t){try{const e=new Uint8Array(r);let o="";const n=32768;for(let s=0;s<e.length;s+=n)o+=String.fromCharCode.apply(null,Array.from(e.subarray(s,s+n)));const a=btoa(o);return t?`data:${t};base64,${a}`:a}catch{return""}}arrayBufferFromB64(r){try{let t=r,e="application/octet-stream";const o=/^data:(.*?);base64,(.*)$/.exec(r);o&&o[1]&&o[2]&&(e=o[1],t=o[2]);const n=atob(t),a=n.length,s=new Uint8Array(a);for(let c=0;c<a;c++)s[c]=n.charCodeAt(c);return{mime:e,buffer:s.buffer}}catch{return{mime:"application/octet-stream",buffer:new ArrayBuffer(0)}}}async getFontsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-fonts","fonts");return(await new Promise((e,o)=>{const n=t.transaction("fonts","readonly").objectStore("fonts").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>o(n.error)})).filter(e=>e.projectId===r).map(e=>({id:e.id,name:e.name,mime:e.mime,bufferBase64:this.b64FromArrayBuffer(e.buffer,e.mime)}))}catch(t){return console.warn("读取字体失败：",t),[]}}async clearFontsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-fonts","fonts"),e=await new Promise((n,a)=>{const s=t.transaction("fonts","readonly").objectStore("fonts").getAll();s.onsuccess=()=>n(s.result||[]),s.onerror=()=>a(s.error)}),o=t.transaction("fonts","readwrite").objectStore("fonts");for(const n of e.filter(a=>a.projectId===r))try{o.delete(n.id)}catch{}}catch{}}async saveFontsByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-fonts","fonts")).transaction("fonts","readwrite").objectStore("fonts");for(const o of t){const n=this.arrayBufferFromB64(o.bufferBase64),a={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:o.name,mime:n.mime||o.mime||"application/octet-stream",buffer:n.buffer,projectId:r};try{e.add(a)}catch{}}}catch(e){console.warn("写入字体失败：",e)}}async deleteFontByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-fonts","fonts")).transaction("fonts","readwrite").objectStore("fonts"),o=await new Promise((n,a)=>{const s=e.get(t);s.onsuccess=()=>n(s.result||null),s.onerror=()=>a(s.error)});o&&o.projectId===r&&await new Promise((n,a)=>{const s=e.delete(t);s.onsuccess=()=>n(),s.onerror=()=>a(s.error)})}catch(e){console.warn("删除字体失败：",e)}}async getIconsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-icons","icons");return(await new Promise((e,o)=>{const n=t.transaction("icons","readonly").objectStore("icons").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>o(n.error)})).filter(e=>e.projectId===r).map(e=>({id:e.id,name:e.name,originalName:e.originalName,mime:e.mime,width:e.width,height:e.height,size:e.size,bufferBase64:this.b64FromArrayBuffer(e.buffer,e.mime)}))}catch(t){return console.warn("读取图标失败：",t),[]}}async clearIconsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-icons","icons"),e=await new Promise((n,a)=>{const s=t.transaction("icons","readonly").objectStore("icons").getAll();s.onsuccess=()=>n(s.result||[]),s.onerror=()=>a(s.error)}),o=t.transaction("icons","readwrite").objectStore("icons");for(const n of e.filter(a=>a.projectId===r))try{o.delete(n.id)}catch{}}catch{}}async saveIconsByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-icons","icons")).transaction("icons","readwrite").objectStore("icons");for(const o of t){const n=this.arrayBufferFromB64(o.bufferBase64),a={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:o.name,originalName:o.originalName,mime:n.mime||o.mime||"application/octet-stream",buffer:n.buffer,width:o.width,height:o.height,size:o.size,projectId:r};try{e.add(a)}catch{}}}catch(e){console.warn("写入图标失败：",e)}}async updateIconNameByComponentId(r,t,e){try{const o=(await this.openIndexedDB("lowcode-icons","icons")).transaction("icons","readwrite").objectStore("icons"),n=await new Promise((a,s)=>{const c=o.get(t);c.onsuccess=()=>a(c.result||null),c.onerror=()=>s(c.error)});n&&n.projectId===r&&(n.name=e,await new Promise((a,s)=>{const c=o.put(n);c.onsuccess=()=>a(),c.onerror=()=>s(c.error)}))}catch(o){console.warn("更新图标名称失败：",o)}}async deleteIconByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-icons","icons")).transaction("icons","readwrite").objectStore("icons"),o=await new Promise((n,a)=>{const s=e.get(t);s.onsuccess=()=>n(s.result||null),s.onerror=()=>a(s.error)});o&&o.projectId===r&&await new Promise((n,a)=>{const s=e.delete(t);s.onsuccess=()=>n(),s.onerror=()=>a(s.error)})}catch(e){console.warn("删除图标失败：",e)}}async getDatabaseObjectsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-db","objects");return(await new Promise((e,o)=>{const n=t.transaction("objects","readonly").objectStore("objects").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>o(n.error)})).filter(e=>!e.projectId||e.projectId===r).map(e=>({id:e.id,name:e.name,description:e.description,content:e.content,createdAt:e.createdAt,updatedAt:e.updatedAt}))}catch(t){return console.warn("读取数据库对象失败：",t),[]}}async clearDatabaseObjectsByComponentId(r){try{const t=await this.openIndexedDB("lowcode-db","objects"),e=await new Promise((n,a)=>{const s=t.transaction("objects","readonly").objectStore("objects").getAll();s.onsuccess=()=>n(s.result||[]),s.onerror=()=>a(s.error)}),o=t.transaction("objects","readwrite").objectStore("objects");for(const n of e.filter(a=>a.projectId===r))try{o.delete(n.id)}catch{}}catch{}}async saveDatabaseObjectsByComponentId(r,t){var e,o;try{const n=(await this.openIndexedDB("lowcode-db","objects")).transaction("objects","readwrite").objectStore("objects");for(const a of t){const s={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:a.name,description:a.description,content:a.content,createdAt:(e=a.createdAt)!=null?e:Date.now(),updatedAt:(o=a.updatedAt)!=null?o:Date.now(),projectId:r};try{n.add(s)}catch{}}}catch(n){console.warn("写入数据库对象失败：",n)}}async upsertDatabaseObjectByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-db","objects")).transaction("objects","readwrite").objectStore("objects"),o=t.id?await new Promise((s,c)=>{const i=e.get(t.id);i.onsuccess=()=>s(i.result||null),i.onerror=()=>c(i.error)}):null,n=t.id||`${Date.now()}-${Math.random().toString(36).slice(2)}`,a={id:n,name:t.name,description:t.description||"",content:t.content,createdAt:(o==null?void 0:o.createdAt)||t.createdAt||Date.now(),updatedAt:Date.now(),projectId:r};return await new Promise((s,c)=>{const i=e.put(a);i.onsuccess=()=>s(),i.onerror=()=>c(i.error)}),{id:n}}catch(e){return console.warn("Upsert 对象失败：",e),{id:t.id||""}}}async deleteDatabaseObjectByComponentId(r,t){try{const e=(await this.openIndexedDB("lowcode-db","objects")).transaction("objects","readwrite").objectStore("objects"),o=await new Promise((n,a)=>{const s=e.get(t);s.onsuccess=()=>n(s.result||null),s.onerror=()=>a(s.error)});o&&o.projectId===r&&await new Promise((n,a)=>{const s=e.delete(t);s.onsuccess=()=>n(),s.onerror=()=>a(s.error)})}catch(e){console.warn("删除对象失败：",e)}}async init(){return new Promise((r,t)=>{const e=indexedDB.open(this.dbName,this.dbVersion);e.onerror=()=>{console.error("Failed to open IndexedDB:",e.error),t(e.error)},e.onsuccess=()=>{this.db=e.result,r()},e.onupgradeneeded=o=>{const n=o.target.result;if(!n.objectStoreNames.contains(this.storeName)){const a=n.createObjectStore(this.storeName,{keyPath:"id"});a.createIndex("name","name",{unique:!1}),a.createIndex("tags","tags",{unique:!1,multiEntry:!0}),a.createIndex("createdAt","createdAt",{unique:!1}),a.createIndex("updatedAt","updatedAt",{unique:!1})}}})}async getAllComponents(){return this.db||await this.init(),new Promise((r,t)=>{const e=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();e.onsuccess=()=>{r(e.result||[])},e.onerror=()=>{t(e.error)}})}async getComponent(r){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(r);o.onsuccess=()=>{t(o.result||null)},o.onerror=()=>{e(o.error)}})}async saveComponent(r){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(r);o.onsuccess=()=>{t()},o.onerror=()=>{e(o.error)}})}async deleteComponent(r){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(r);o.onsuccess=()=>{t()},o.onerror=()=>{e(o.error)}})}async searchComponents(r){const t=await this.getAllComponents(),e=r.toLowerCase();return t.filter(o=>{var n,a;return o.name.toLowerCase().includes(e)||((n=o.description)==null?void 0:n.toLowerCase().includes(e))||((a=o.tags)==null?void 0:a.some(s=>s.toLowerCase().includes(e)))})}async getComponentsByTags(r){return(await this.getAllComponents()).filter(t=>r.every(e=>{var o;return(o=t.tags)==null?void 0:o.includes(e)}))}async incrementUsageCount(r){const t=await this.getComponent(r);t&&(t.usageCount=(t.usageCount||0)+1,t.updatedAt=Date.now(),await this.saveComponent(t))}async exportComponents(r){const t=[],e=r&&r.length>0?r:(await this.getAllComponents()).map(o=>o.id);for(const o of e){const n=await this.getComponent(o);if(!n)continue;const a=await this.getBuilderStateByComponentId(n.id),s={...n};a!=null&&a.elements&&(s.elements=a.elements,s.config=a.config,s.updatedAt=Date.now());const c=await this.getFontsByComponentId(n.id),i=await this.getIconsByComponentId(n.id),d=await this.getDatabaseObjectsByComponentId(n.id);t.push({component:s,builderState:a||null,fonts:c,icons:i,dbObjects:d})}return t}async importComponents(r){let t=0;const e=[];for(const o of r){const n=!!o&&typeof o=="object"&&"component"in o,a=n?o.component:o;try{const s=(await this.searchComponents(a.name)).find(c=>c.name===a.name);if(s){const c={...a,id:s.id,updatedAt:Date.now()};await this.saveComponent(c);const i=c.id;n&&o.builderState?await this.saveBuilderStateByComponentId(i,o.builderState):(a.elements||a.config)&&await this.saveBuilderStateByComponentId(i,{config:a.config||{},elements:a.elements||[],exportName:a.name}),n&&Array.isArray(o.fonts)&&(await this.clearFontsByComponentId(i),await this.saveFontsByComponentId(i,o.fonts)),n&&Array.isArray(o.icons)&&(await this.clearIconsByComponentId(i),await this.saveIconsByComponentId(i,o.icons)),n&&Array.isArray(o.dbObjects)&&(await this.clearDatabaseObjectsByComponentId(i),await this.saveDatabaseObjectsByComponentId(i,o.dbObjects))}else{const c={...a,id:Date.now().toString()+Math.random().toString(36).substr(2,9),createdAt:Date.now(),updatedAt:Date.now()};await this.saveComponent(c);const i=c.id;n&&o.builderState?await this.saveBuilderStateByComponentId(i,o.builderState):(a.elements||a.config)&&await this.saveBuilderStateByComponentId(i,{config:a.config||{},elements:a.elements||[],exportName:a.name}),n&&Array.isArray(o.fonts)&&(await this.clearFontsByComponentId(i),await this.saveFontsByComponentId(i,o.fonts)),n&&Array.isArray(o.icons)&&(await this.clearIconsByComponentId(i),await this.saveIconsByComponentId(i,o.icons)),n&&Array.isArray(o.dbObjects)&&(await this.clearDatabaseObjectsByComponentId(i),await this.saveDatabaseObjectsByComponentId(i,o.dbObjects))}t++}catch(s){e.push(`导入组件 "${a.name}" 失败: ${s}`)}}return{success:t,errors:e}}};const m=new l;export{m as t};
