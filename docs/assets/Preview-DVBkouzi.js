import{E as p,L as D,O as P,R as S,_ as $,c as O,ct as R,f as v,l as M,o as U,u as q,w as z}from"./codemirror-B25QCqWr.js";import{o as L}from"./vendor-vue-fZ-TTK_Z.js";import"./echarts-CeA8Xwre.js";import{t as V}from"./DraggableBox-D_w9MXsh.js";var T=$({__name:"index",props:{projectId:{},isComponent:{type:Boolean}},setup(j){const b=j,B=L(),g=O(()=>b.projectId||String(B.params.id||"")),d=D({width:1024,height:768,backgroundUrl:"",backgroundColor:"#111827",globalFontFamily:"Arial, Helvetica, sans-serif",globalFontSize:14,globalColor:"#FFFFFF"}),m=S([]),y=S(1);function _(){const e=g.value||"default";return b.isComponent?`component-${e}`:`project-${e}`}async function k(){return new Promise((e,t)=>{const n="lowcode-builder",c="states",s=indexedDB.open(n);s.onerror=()=>t(s.error),s.onupgradeneeded=()=>{const o=s.result;o.objectStoreNames.contains(c)||o.createObjectStore(c,{keyPath:"id"})},s.onsuccess=()=>{const o=s.result;if(o.objectStoreNames.contains(c))e(o);else{const i=o.version+1;o.close();const a=indexedDB.open(n,i);a.onupgradeneeded=()=>{const l=a.result;l.objectStoreNames.contains(c)||l.createObjectStore(c,{keyPath:"id"})},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)}}})}async function x(e){try{const t=await k(),n=await new Promise((c,s)=>{const o=t.transaction("states","readonly").objectStore("states").get(e);o.onsuccess=()=>c(o.result||null),o.onerror=()=>s(o.error)});return n?{config:n.config,elements:n.elements}:null}catch(t){return console.warn("预览恢复失败：",t),null}}async function C(e){try{const t="lowcode-icons",n="icons",c=indexedDB.open(t),s=await new Promise((a,l)=>{c.onsuccess=()=>{const r=c.result;if(r.objectStoreNames.contains(n))a(r);else{const f=r.version+1;r.close();const u=indexedDB.open(t,f);u.onupgradeneeded=()=>{const h=u.result;h.objectStoreNames.contains(n)||h.createObjectStore(n,{keyPath:"id"})},u.onsuccess=()=>a(u.result),u.onerror=()=>l(u.error)}},c.onerror=()=>l(c.error)}),o=await new Promise((a,l)=>{const r=s.transaction(n,"readonly").objectStore(n).get(e);r.onsuccess=()=>a(r.result),r.onerror=()=>l(r.error)});if(!o||!o.buffer)return null;const i=new Blob([o.buffer],{type:o.mime||"application/octet-stream"});return await new Promise((a,l)=>{const r=new FileReader;r.onload=()=>a(String(r.result)),r.onerror=()=>l(r.error),r.readAsDataURL(i)})}catch(t){return console.warn("读取图标数据失败：",t),null}}async function E(){const e=m.value.filter(t=>t.type==="image");for(const t of e){if((t.src||"").startsWith("data:"))continue;const n=t.iconId;if(!n)continue;const c=await C(n);c&&(t.src=c)}}function w(e){return String(e).split(";").map(t=>t.trim()).filter(Boolean).map(t=>t.includes("!important")?t:`${t} !important`).join("; ")}function I(e){return String(e).replace(/\{([^}]*)\}/g,(t,n)=>`{ ${w(n)} }`)}function A(e){const t=(e.className||"").trim(),n=(e.customClassCss||"").trim();return!t||!n?"":/\{[^}]*\}/.test(n)?I(n):`.${t} { ${w(n)} }`}function F(){let e=document.querySelector("style[data-preview-custom-class]");e||(e=document.createElement("style"),e.setAttribute("data-preview-custom-class",""),document.head.appendChild(e));const t=[],n=m.value||[],c=s=>{s.forEach(o=>{if(o.type==="group"&&Array.isArray(o.children))c(o.children);else{const i=A(o);i&&t.push(i)}})};c(n),e&&(e.textContent=t.join(`
`))}async function N(){try{const e="lowcode-fonts",t="fonts",n=await new Promise((s,o)=>{const i=indexedDB.open(e);i.onsuccess=()=>{const a=i.result;if(a.objectStoreNames.contains(t))s(a);else{const l=a.version+1;a.close();const r=indexedDB.open(e,l);r.onupgradeneeded=()=>{const f=r.result;f.objectStoreNames.contains(t)||f.createObjectStore(t,{keyPath:"id"})},r.onsuccess=()=>s(r.result),r.onerror=()=>o(r.error)}},i.onerror=()=>o(i.error)}),c=await new Promise((s,o)=>{const i=n.transaction(t,"readonly").objectStore(t).getAll();i.onsuccess=()=>s(i.result),i.onerror=()=>o(i.error)});if(c.length>0){let s=document.querySelector("style[data-font-lib]");s||(s=document.createElement("style"),s.setAttribute("data-font-lib",""),document.head.appendChild(s));const o=[],i=g.value,a=i?c.filter(l=>l.projectId===i):c.filter(l=>!l.projectId);for(const l of a){const r=new Blob([l.buffer],{type:l.mime}),f=URL.createObjectURL(r),u=l.name;o.push(`@font-face { font-family: '${u}'; src: url('${f}'); font-weight: normal; font-style: normal; }`)}s.textContent=o.join(`
`)}}catch(e){console.warn("字体库初始化失败：",e)}}return z(async()=>{await N();const e=await x(_());e&&(e.config&&Object.assign(d,e.config),Array.isArray(e.elements)&&(m.value=e.elements),await E(),F())}),(e,t)=>(p(),v("div",null,[M("div",{style:R({position:"relative",width:`${d.width}px`,height:`${d.height}px`,backgroundColor:d.backgroundColor||"transparent",backgroundImage:d.backgroundUrl?`url(${d.backgroundUrl})`:"none",backgroundSize:"cover",backgroundPosition:"center",transform:`scale(${y.value})`,transformOrigin:"top left"})},[(p(!0),v(U,null,P(m.value,n=>(p(),q(V,{key:n.id,element:n,selected:!1,config:d,zoom:y.value,dbMap:{},"metrics-map":{},preview:!0},null,8,["element","config","zoom"]))),128))],4)]))}}),K=T;export{K as default};
