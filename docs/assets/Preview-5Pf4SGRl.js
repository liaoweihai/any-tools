import{E as g,L as R,O as M,R as y,_ as U,c as B,ct as z,f as _,l as L,o as q,u as V,w as T}from"./codemirror-B25QCqWr.js";import{o as W}from"./vendor-vue-C93_ecI2.js";import{t as w}from"./componentStorage-DB4dbTb9.js";import"./echarts-xBohgwka.js";import{t as H}from"./DraggableBox-v_Wtusqs.js";var G=U({__name:"index",props:{projectId:{},isComponent:{type:Boolean}},setup(C){const h=C,F=W(),b=B(()=>h.projectId||String(F.params.id||"")),d=R({width:1024,height:768,backgroundUrl:"",backgroundColor:"#111827",globalFontFamily:"Arial, Helvetica, sans-serif",globalFontSize:14,globalColor:"#FFFFFF"}),m=y([]),v=y(1),p=y([]);async function I(){try{const e=String(b.value||"");if(!e){p.value=[];return}p.value=await w.getDatabaseObjectsByComponentId(e)}catch(e){console.warn("读取数据库对象失败：",e),p.value=[]}}const k=B(()=>{const e={};for(const t of p.value)t&&t.name&&(e[t.name]=t.content);return e});function x(){const e=b.value||"default";return h.isComponent?`component-${e}`:`project-${e}`}async function E(e){try{if(e.startsWith("component-")){const t=e.replace(/^component-/,""),o=await w.getBuilderStateForComponent(t);return o?{config:o.config,elements:o.elements||[]}:null}else{const t=e.replace(/^project-/,""),o=await w.getBuilderStateForProject(t);return o?{config:o.config,elements:o.elements||[]}:null}}catch(t){return console.warn("预览恢复失败：",t),null}}async function A(e){try{const t="lowcode-icons",o="icons",c=indexedDB.open(t),i=await new Promise((l,a)=>{c.onsuccess=()=>{const n=c.result;if(n.objectStoreNames.contains(o))l(n);else{const f=n.version+1;n.close();const u=indexedDB.open(t,f);u.onupgradeneeded=()=>{const j=u.result;j.objectStoreNames.contains(o)||j.createObjectStore(o,{keyPath:"id"})},u.onsuccess=()=>l(u.result),u.onerror=()=>a(u.error)}},c.onerror=()=>a(c.error)}),r=await new Promise((l,a)=>{const n=i.transaction(o,"readonly").objectStore(o).get(e);n.onsuccess=()=>l(n.result),n.onerror=()=>a(n.error)});if(!r||!r.buffer)return null;const s=new Blob([r.buffer],{type:r.mime||"application/octet-stream"});return await new Promise((l,a)=>{const n=new FileReader;n.onload=()=>l(String(n.result)),n.onerror=()=>a(n.error),n.readAsDataURL(s)})}catch(t){return console.warn("读取图标数据失败：",t),null}}async function D(){const e=m.value.filter(t=>t.type==="image");for(const t of e){if((t.src||"").startsWith("data:"))continue;const o=t.iconId;if(!o)continue;const c=await A(o);c&&(t.src=c)}}function S(e){return String(e).split(";").map(t=>t.trim()).filter(Boolean).map(t=>t.includes("!important")?t:`${t} !important`).join("; ")}function $(e){return String(e).replace(/\{([^}]*)\}/g,(t,o)=>`{ ${S(o)} }`)}function O(e){const t=(e.className||"").trim(),o=(e.customClassCss||"").trim();return!t||!o?"":/\{[^}]*\}/.test(o)?$(o):`.${t} { ${S(o)} }`}function P(){let e=document.querySelector("style[data-preview-custom-class]");e||(e=document.createElement("style"),e.setAttribute("data-preview-custom-class",""),document.head.appendChild(e));const t=[],o=m.value||[],c=i=>{i.forEach(r=>{if(r.type==="group"&&Array.isArray(r.children))c(r.children);else{const s=O(r);s&&t.push(s)}})};c(o),e&&(e.textContent=t.join(`
`))}async function N(){try{const e="lowcode-fonts",t="fonts",o=await new Promise((i,r)=>{const s=indexedDB.open(e);s.onsuccess=()=>{const l=s.result;if(l.objectStoreNames.contains(t))i(l);else{const a=l.version+1;l.close();const n=indexedDB.open(e,a);n.onupgradeneeded=()=>{const f=n.result;f.objectStoreNames.contains(t)||f.createObjectStore(t,{keyPath:"id"})},n.onsuccess=()=>i(n.result),n.onerror=()=>r(n.error)}},s.onerror=()=>r(s.error)}),c=await new Promise((i,r)=>{const s=o.transaction(t,"readonly").objectStore(t).getAll();s.onsuccess=()=>i(s.result),s.onerror=()=>r(s.error)});if(c.length>0){let i=document.querySelector("style[data-font-lib]");i||(i=document.createElement("style"),i.setAttribute("data-font-lib",""),document.head.appendChild(i));const r=[],s=b.value,l=s?c.filter(a=>a.projectId===s):c.filter(a=>!a.projectId);for(const a of l){const n=new Blob([a.buffer],{type:a.mime}),f=URL.createObjectURL(n),u=a.name;r.push(`@font-face { font-family: '${u}'; src: url('${f}'); font-weight: normal; font-style: normal; }`)}i.textContent=r.join(`
`)}}catch(e){console.warn("字体库初始化失败：",e)}}return T(async()=>{await N(),await I();const e=await E(x());e&&(e.config&&Object.assign(d,e.config),Array.isArray(e.elements)&&(m.value=e.elements),await D(),P())}),(e,t)=>(g(),_("div",null,[L("div",{style:z({position:"relative",width:`${d.width}px`,height:`${d.height}px`,backgroundColor:d.backgroundColor||"transparent",backgroundImage:d.backgroundUrl?`url(${d.backgroundUrl})`:"none",backgroundSize:"cover",backgroundPosition:"center",transform:`scale(${v.value})`,transformOrigin:"top left"})},[(g(!0),_(q,null,M(m.value,o=>(g(),V(H,{key:o.id,element:o,selected:!1,config:d,zoom:v.value,dbMap:k.value,"metrics-map":{},preview:!0},null,8,["element","config","zoom","dbMap"]))),128))],4)]))}}),Z=G;export{Z as default};
