var m=class{constructor(){this.dbName="vue-tools-components-db",this.dbVersion=1,this.storeName="components",this.db=null}async openIndexedDB(r,n){return new Promise((e,t)=>{const o=indexedDB.open(r);o.onerror=()=>t(o.error),o.onupgradeneeded=()=>{const s=o.result;s.objectStoreNames.contains(n)||s.createObjectStore(n,{keyPath:"id"})},o.onsuccess=()=>{const s=o.result;if(s.objectStoreNames.contains(n))e(s);else{const a=s.version+1;s.close();const c=indexedDB.open(r,a);c.onerror=()=>t(c.error),c.onupgradeneeded=()=>{const i=c.result;i.objectStoreNames.contains(n)||i.createObjectStore(n,{keyPath:"id"})},c.onsuccess=()=>e(c.result)}}})}async getBuilderStateByComponentId(r){try{const n=await this.openIndexedDB("lowcode-builder","states");return await new Promise((e,t)=>{const o=n.transaction("states","readonly").objectStore("states"),s=`component-${r}`,a=o.get(s);a.onsuccess=()=>e(a.result?{config:a.result.config,elements:a.result.elements||[],exportName:a.result.exportName}:null),a.onerror=()=>t(a.error)})}catch(n){return console.warn("读取构建器状态失败：",n),null}}async saveBuilderStateByComponentId(r,n){try{const e=await this.openIndexedDB("lowcode-builder","states");await new Promise((t,o)=>{const s=e.transaction("states","readwrite").objectStore("states"),a=`component-${r}`,c=s.put({id:a,...n,updatedAt:Date.now()});c.onsuccess=()=>t(),c.onerror=()=>o(c.error)})}catch(e){console.warn("写入构建器状态失败：",e)}}b64FromArrayBuffer(r,n){try{const e=new Uint8Array(r);let t="";const o=32768;for(let a=0;a<e.length;a+=o)t+=String.fromCharCode.apply(null,Array.from(e.subarray(a,a+o)));const s=btoa(t);return n?`data:${n};base64,${s}`:s}catch{return""}}arrayBufferFromB64(r){try{let n=r,e="application/octet-stream";const t=/^data:(.*?);base64,(.*)$/.exec(r);t&&t[1]&&t[2]&&(e=t[1],n=t[2]);const o=atob(n),s=o.length,a=new Uint8Array(s);for(let c=0;c<s;c++)a[c]=o.charCodeAt(c);return{mime:e,buffer:a.buffer}}catch{return{mime:"application/octet-stream",buffer:new ArrayBuffer(0)}}}async getFontsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-fonts","fonts");return(await new Promise((e,t)=>{const o=n.transaction("fonts","readonly").objectStore("fonts").getAll();o.onsuccess=()=>e(o.result||[]),o.onerror=()=>t(o.error)})).filter(e=>e.projectId===r).map(e=>({id:e.id,name:e.name,mime:e.mime,bufferBase64:this.b64FromArrayBuffer(e.buffer,e.mime)}))}catch(n){return console.warn("读取字体失败：",n),[]}}async clearFontsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-fonts","fonts"),e=await new Promise((o,s)=>{const a=n.transaction("fonts","readonly").objectStore("fonts").getAll();a.onsuccess=()=>o(a.result||[]),a.onerror=()=>s(a.error)}),t=n.transaction("fonts","readwrite").objectStore("fonts");for(const o of e.filter(s=>s.projectId===r))try{t.delete(o.id)}catch{}}catch{}}async saveFontsByComponentId(r,n){try{const e=(await this.openIndexedDB("lowcode-fonts","fonts")).transaction("fonts","readwrite").objectStore("fonts");for(const t of n){const o=this.arrayBufferFromB64(t.bufferBase64),s={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:t.name,mime:o.mime||t.mime||"application/octet-stream",buffer:o.buffer,projectId:r};try{e.add(s)}catch{}}}catch(e){console.warn("写入字体失败：",e)}}async getIconsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-icons","icons");return(await new Promise((e,t)=>{const o=n.transaction("icons","readonly").objectStore("icons").getAll();o.onsuccess=()=>e(o.result||[]),o.onerror=()=>t(o.error)})).filter(e=>e.projectId===r).map(e=>({id:e.id,name:e.name,originalName:e.originalName,mime:e.mime,width:e.width,height:e.height,size:e.size,bufferBase64:this.b64FromArrayBuffer(e.buffer,e.mime)}))}catch(n){return console.warn("读取图标失败：",n),[]}}async clearIconsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-icons","icons"),e=await new Promise((o,s)=>{const a=n.transaction("icons","readonly").objectStore("icons").getAll();a.onsuccess=()=>o(a.result||[]),a.onerror=()=>s(a.error)}),t=n.transaction("icons","readwrite").objectStore("icons");for(const o of e.filter(s=>s.projectId===r))try{t.delete(o.id)}catch{}}catch{}}async saveIconsByComponentId(r,n){try{const e=(await this.openIndexedDB("lowcode-icons","icons")).transaction("icons","readwrite").objectStore("icons");for(const t of n){const o=this.arrayBufferFromB64(t.bufferBase64),s={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:t.name,originalName:t.originalName,mime:o.mime||t.mime||"application/octet-stream",buffer:o.buffer,width:t.width,height:t.height,size:t.size,projectId:r};try{e.add(s)}catch{}}}catch(e){console.warn("写入图标失败：",e)}}async getDatabaseObjectsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-db","objects");return(await new Promise((e,t)=>{const o=n.transaction("objects","readonly").objectStore("objects").getAll();o.onsuccess=()=>e(o.result||[]),o.onerror=()=>t(o.error)})).filter(e=>!e.projectId||e.projectId===r).map(e=>({id:e.id,name:e.name,description:e.description,content:e.content,createdAt:e.createdAt,updatedAt:e.updatedAt}))}catch(n){return console.warn("读取数据库对象失败：",n),[]}}async clearDatabaseObjectsByComponentId(r){try{const n=await this.openIndexedDB("lowcode-db","objects"),e=await new Promise((o,s)=>{const a=n.transaction("objects","readonly").objectStore("objects").getAll();a.onsuccess=()=>o(a.result||[]),a.onerror=()=>s(a.error)}),t=n.transaction("objects","readwrite").objectStore("objects");for(const o of e.filter(s=>s.projectId===r))try{t.delete(o.id)}catch{}}catch{}}async saveDatabaseObjectsByComponentId(r,n){var e,t;try{const o=(await this.openIndexedDB("lowcode-db","objects")).transaction("objects","readwrite").objectStore("objects");for(const s of n){const a={id:`${Date.now()}-${Math.random().toString(36).slice(2)}`,name:s.name,description:s.description,content:s.content,createdAt:(e=s.createdAt)!=null?e:Date.now(),updatedAt:(t=s.updatedAt)!=null?t:Date.now(),projectId:r};try{o.add(a)}catch{}}}catch(o){console.warn("写入数据库对象失败：",o)}}async init(){return new Promise((r,n)=>{const e=indexedDB.open(this.dbName,this.dbVersion);e.onerror=()=>{console.error("Failed to open IndexedDB:",e.error),n(e.error)},e.onsuccess=()=>{this.db=e.result,r()},e.onupgradeneeded=t=>{const o=t.target.result;if(!o.objectStoreNames.contains(this.storeName)){const s=o.createObjectStore(this.storeName,{keyPath:"id"});s.createIndex("name","name",{unique:!1}),s.createIndex("tags","tags",{unique:!1,multiEntry:!0}),s.createIndex("createdAt","createdAt",{unique:!1}),s.createIndex("updatedAt","updatedAt",{unique:!1})}}})}async getAllComponents(){return this.db||await this.init(),new Promise((r,n)=>{const e=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();e.onsuccess=()=>{r(e.result||[])},e.onerror=()=>{n(e.error)}})}async getComponent(r){return this.db||await this.init(),new Promise((n,e)=>{const t=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(r);t.onsuccess=()=>{n(t.result||null)},t.onerror=()=>{e(t.error)}})}async saveComponent(r){return this.db||await this.init(),new Promise((n,e)=>{const t=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(r);t.onsuccess=()=>{n()},t.onerror=()=>{e(t.error)}})}async deleteComponent(r){return this.db||await this.init(),new Promise((n,e)=>{const t=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(r);t.onsuccess=()=>{n()},t.onerror=()=>{e(t.error)}})}async searchComponents(r){const n=await this.getAllComponents(),e=r.toLowerCase();return n.filter(t=>{var o,s;return t.name.toLowerCase().includes(e)||((o=t.description)==null?void 0:o.toLowerCase().includes(e))||((s=t.tags)==null?void 0:s.some(a=>a.toLowerCase().includes(e)))})}async getComponentsByTags(r){return(await this.getAllComponents()).filter(n=>r.every(e=>{var t;return(t=n.tags)==null?void 0:t.includes(e)}))}async incrementUsageCount(r){const n=await this.getComponent(r);n&&(n.usageCount=(n.usageCount||0)+1,n.updatedAt=Date.now(),await this.saveComponent(n))}async exportComponents(r){const n=[],e=r&&r.length>0?r:(await this.getAllComponents()).map(t=>t.id);for(const t of e){const o=await this.getComponent(t);if(!o)continue;const s=await this.getBuilderStateByComponentId(o.id),a={...o};s!=null&&s.elements&&(a.elements=s.elements,a.config=s.config,a.updatedAt=Date.now());const c=await this.getFontsByComponentId(o.id),i=await this.getIconsByComponentId(o.id),d=await this.getDatabaseObjectsByComponentId(o.id);n.push({component:a,builderState:s||null,fonts:c,icons:i,dbObjects:d})}return n}async importComponents(r){let n=0;const e=[];for(const t of r){const o=!!t&&typeof t=="object"&&"component"in t,s=o?t.component:t;try{const a=(await this.searchComponents(s.name)).find(c=>c.name===s.name);if(a){const c={...s,id:a.id,updatedAt:Date.now()};await this.saveComponent(c);const i=c.id;o&&t.builderState?await this.saveBuilderStateByComponentId(i,t.builderState):(s.elements||s.config)&&await this.saveBuilderStateByComponentId(i,{config:s.config||{},elements:s.elements||[],exportName:s.name}),o&&Array.isArray(t.fonts)&&(await this.clearFontsByComponentId(i),await this.saveFontsByComponentId(i,t.fonts)),o&&Array.isArray(t.icons)&&(await this.clearIconsByComponentId(i),await this.saveIconsByComponentId(i,t.icons)),o&&Array.isArray(t.dbObjects)&&(await this.clearDatabaseObjectsByComponentId(i),await this.saveDatabaseObjectsByComponentId(i,t.dbObjects))}else{const c={...s,id:Date.now().toString()+Math.random().toString(36).substr(2,9),createdAt:Date.now(),updatedAt:Date.now()};await this.saveComponent(c);const i=c.id;o&&t.builderState?await this.saveBuilderStateByComponentId(i,t.builderState):(s.elements||s.config)&&await this.saveBuilderStateByComponentId(i,{config:s.config||{},elements:s.elements||[],exportName:s.name}),o&&Array.isArray(t.fonts)&&(await this.clearFontsByComponentId(i),await this.saveFontsByComponentId(i,t.fonts)),o&&Array.isArray(t.icons)&&(await this.clearIconsByComponentId(i),await this.saveIconsByComponentId(i,t.icons)),o&&Array.isArray(t.dbObjects)&&(await this.clearDatabaseObjectsByComponentId(i),await this.saveDatabaseObjectsByComponentId(i,t.dbObjects))}n++}catch(a){e.push(`导入组件 "${s.name}" 失败: ${a}`)}}return{success:n,errors:e}}};const l=new m;export{l as t};
